<!DOCTYPE html>
<html lang="ar" dir="rtl" class="auth-page">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إنشاء حساب - نظام عدالة</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/main.css">
</head>

<body class="auth-page">
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; justify-content:center; align-items:center;">
        <div class="loading-spinner" style="background:white; padding:2rem; border-radius:10px; text-align:center;">
            <i class="fas fa-spinner fa-spin fa-2x" style="color:var(--brand-primary); margin-bottom:1rem;"></i>
            <div>جاري إنشاء الحساب...</div>
        </div>
    </div>

    <div class="auth-wrapper">
        <div class="auth-card-modern" style="max-width: 650px;">
            <!-- Branding Section -->
            <div class="auth-branding" style="display: flex; flex-direction: column; align-items: center;">
                <div class="brand-logo-container" style="width: 60px; height: 60px; margin-bottom: 1rem;">
                    <i class="fas fa-balance-scale"></i>
                </div>
                <h1 class="brand-name" style="font-size: 1.5rem; color: var(--text-main);">نظام عدالة</h1>
            </div>

            <div class="auth-header-modern">
                <h1 class="auth-title-modern">إنشاء حساب جديد</h1>
                <p class="auth-subtitle-modern">انضم إلى نظام عدالة وادمج مكتبك الرقمي اليوم</p>
            </div>

            <form id="registerForm" novalidate>
                <div class="form-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.25rem;">
                    <!-- الاسم الكامل -->
                    <div class="form-group" style="grid-column: span 2;">
                        <label for="full_name" class="form-label">الاسم الكامل *</label>
                        <input type="text" id="full_name" class="form-control" required placeholder="أدخل اسمك بالكامل"
                            style="height: 45px;">
                        <div class="feedback neutral" id="fullNameFeedback">
                            <i class="fas fa-info-circle"></i> حرفين على الأقل
                        </div>
                    </div>

                    <!-- اسم المستخدم -->
                    <div class="form-group">
                        <label for="username" class="form-label">اسم المستخدم *</label>
                        <input type="text" id="username" class="form-control" required placeholder="username"
                            style="height: 45px;">
                        <div class="feedback neutral" id="usernameFeedback">
                            <i class="fas fa-info-circle"></i> فريد - 3 أحرف
                        </div>
                    </div>

                    <!-- الدور -->
                    <div class="form-group">
                        <label for="role" class="form-label">الدور الوظيفي *</label>
                        <select id="role" class="form-control" required style="height: 45px;">
                            <option value="">اختر الدور</option>
                            <option value="lawyer">محامي</option>
                            <option value="assistant">مساعد قانوني</option>
                            <option value="admin">مدير نظام</option>
                        </select>
                    </div>

                    <!-- البريد الإلكتروني -->
                    <div class="form-group" style="grid-column: span 2;">
                        <label for="email" class="form-label">البريد الإلكتروني *</label>
                        <input type="email" id="email" class="form-control" required placeholder="email@example.com"
                            style="height: 45px;">
                        <div class="feedback neutral" id="emailFeedback">
                            <i class="fas fa-envelope"></i> بريد صالح
                        </div>
                    </div>

                    <!-- رقم الهاتف -->
                    <div class="form-group">
                        <label for="phone" class="form-label">رقم الهاتف</label>
                        <input type="tel" id="phone" class="form-control" placeholder="05XXXXXXXX"
                            style="height: 45px;">
                    </div>

                    <!-- التخصص -->
                    <div class="form-group">
                        <label for="specialization" class="form-label">التخصص</label>
                        <input type="text" id="specialization" class="form-control" placeholder="القانون المدني"
                            style="height: 45px;">
                    </div>

                    <!-- كلمة المرور -->
                    <div class="form-group" style="position: relative;">
                        <label for="password" class="form-label">كلمة المرور *</label>
                        <div style="position: relative;">
                            <input type="password" id="password" class="form-control" required placeholder="••••••••"
                                style="height: 45px;">
                            <button type="button" class="password-toggle" id="togglePassword"
                                style="top: 50%; transform: translateY(-50%); opacity: 0.6;">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="password-strength">
                            <div class="password-strength-bar" id="passwordStrengthBar"></div>
                        </div>
                    </div>

                    <!-- تأكيد كلمة المرور -->
                    <div class="form-group" style="position: relative;">
                        <label for="confirm_password" class="form-label">تأكيد كلمة المرور *</label>
                        <div style="position: relative;">
                            <input type="password" id="confirm_password" class="form-control" required
                                placeholder="••••••••" style="height: 45px;">
                            <button type="button" class="password-toggle" id="toggleConfirmPassword"
                                style="top: 50%; transform: translateY(-50%); opacity: 0.6;">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary btn-block" id="registerBtn" disabled
                    style="margin-top: 2rem; padding: 1rem; border-radius: 12px; font-size: 1.1rem; height: 55px;">
                    <i class="fas fa-user-plus"></i>
                    تأكيد إنشاء الحساب
                </button>
            </form>

            <div class="auth-footer"
                style="margin-top: 2rem; border-top: 1px solid rgba(0,0,0,0.05); padding-top: 2rem;">
                <p>لديك حساب بالفعل؟ <a href="/login" class="auth-link" style="font-weight: 700;">سجل الدخول الآن</a>
                </p>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/utils.js"></script>
    <script>
        class RegisterManager {
            constructor() {
                this.validationState = {
                    full_name: false,
                    username: false,
                    email: false,
                    password: false,
                    confirm_password: false,
                    role: false
                };

                // إنشاء دوال debounce
                this.debouncedCheckUsername = Utils.debounce((username) => {
                    this.checkUsernameAvailability(username);
                }, 500);

                this.debouncedCheckEmail = Utils.debounce((email) => {
                    this.checkEmailAvailability(email);
                }, 500);

                this.init();
            }

            init() {
                this.checkAuth();
                this.setupEventListeners();
                this.updateSubmitButton();
                console.log('✅ مدير التسجيل جاهز');
            }

            async checkAuth() {
                try {
                    const response = await fetch('/api/auth/status', {
                        credentials: 'include'
                    });
                    const data = await response.json();

                    if (data.authenticated) {
                        Utils.redirect('/dashboard', 'أنت مسجل الدخول بالفعل!', 'info');
                    }
                } catch (error) {
                    console.log('المستخدم غير مسجل الدخول');
                }
            }

            setupEventListeners() {
                // الاسم الكامل
                document.getElementById('full_name').addEventListener('input', (e) => {
                    this.validateFullName(e.target.value);
                });

                // اسم المستخدم
                document.getElementById('username').addEventListener('input', (e) => {
                    const username = e.target.value.trim();
                    this.debouncedCheckUsername(username);
                });

                // البريد الإلكتروني
                document.getElementById('email').addEventListener('input', (e) => {
                    const email = e.target.value.trim();
                    this.debouncedCheckEmail(email);
                });

                // كلمة المرور
                document.getElementById('password').addEventListener('input', (e) => {
                    this.validatePassword(e.target.value);
                    this.validatePasswordMatch();
                });

                // تأكيد كلمة المرور
                document.getElementById('confirm_password').addEventListener('input', () => {
                    this.validatePasswordMatch();
                });

                // الدور
                document.getElementById('role').addEventListener('change', (e) => {
                    this.validateRole(e.target.value);
                });

                // إظهار/إخفاء كلمة المرور
                document.getElementById('togglePassword').addEventListener('click', () => {
                    this.togglePasswordVisibility('password', 'togglePassword');
                });

                document.getElementById('toggleConfirmPassword').addEventListener('click', () => {
                    this.togglePasswordVisibility('confirm_password', 'toggleConfirmPassword');
                });

                // إرسال النموذج
                document.getElementById('registerForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleSubmit();
                });
            }

            // ✅ التحقق من الاسم الكامل
            validateFullName(value) {
                const trimmed = value.trim();
                const isValid = trimmed.length >= 2 && trimmed.length <= 100;

                this.updateFieldValidation('full_name', isValid,
                    isValid ? '✓ الاسم صالح' : '✗ يجب أن يكون بين 2 و 100 حرف');

                this.updateFieldStyle('full_name', isValid);
                return isValid;
            }

            // ✅ التحقق من اسم المستخدم
            async checkUsernameAvailability(username) {
                if (username.length < 3) {
                    this.updateFieldValidation('username', false,
                        '✗ يجب أن يكون 3 أحرف على الأقل');
                    this.updateFieldStyle('username', false);
                    return false;
                }

                if (!/^[a-zA-Z0-9_\u0600-\u06FF]+$/.test(username)) {
                    this.updateFieldValidation('username', false,
                        '✗ مسموح: عربي، إنجليزي، أرقام و _ فقط');
                    this.updateFieldStyle('username', false);
                    return false;
                }

                try {
                    const encodedUsername = encodeURIComponent(username);
                    const response = await fetch(`/api/auth/check-username/${encodedUsername}`, {
                        credentials: 'include'
                    });

                    if (!response.ok) throw new Error('فشل في الاتصال بالخادم');

                    const data = await response.json();

                    if (data.available) {
                        this.updateFieldValidation('username', true, '✓ اسم المستخدم متاح');
                        this.updateFieldStyle('username', true);
                        return true;
                    } else {
                        this.updateFieldValidation('username', false, '✗ اسم المستخدم موجود مسبقاً');
                        this.updateFieldStyle('username', false);
                        return false;
                    }
                } catch (error) {
                    console.error('Error checking username:', error);
                    this.updateFieldValidation('username', false, '✗ فشل في التحقق');
                    this.updateFieldStyle('username', false);
                    return false;
                }
            }

            // ✅ التحقق من البريد الإلكتروني
            async checkEmailAvailability(email) {
                if (!Utils.isValidEmail(email)) {
                    this.updateFieldValidation('email', false, '✗ البريد الإلكتروني غير صالح');
                    this.updateFieldStyle('email', false);
                    return false;
                }

                try {
                    const encodedEmail = encodeURIComponent(email);
                    const response = await fetch(`/api/auth/check-email/${encodedEmail}`, {
                        credentials: 'include'
                    });

                    if (!response.ok) throw new Error('فشل في الاتصال بالخادم');

                    const data = await response.json();

                    if (data.available) {
                        this.updateFieldValidation('email', true, '✓ البريد الإلكتروني متاح');
                        this.updateFieldStyle('email', true);
                        return true;
                    } else {
                        this.updateFieldValidation('email', false, '✗ البريد الإلكتروني موجود مسبقاً');
                        this.updateFieldStyle('email', false);
                        return false;
                    }
                } catch (error) {
                    console.error('Error checking email:', error);
                    this.updateFieldValidation('email', false, '✗ فشل في التحقق');
                    this.updateFieldStyle('email', false);
                    return false;
                }
            }

            // ✅ التحقق من قوة كلمة المرور
            validatePassword(password) {
                if (password.length === 0) {
                    this.updateFieldValidation('password', false, '✗ كلمة المرور مطلوبة');
                    this.updateFieldStyle('password', false);
                    this.updatePasswordStrength(0, 'غير محددة');
                    return false;
                }

                if (password.length < 6) {
                    this.updateFieldValidation('password', false, '✗ يجب أن تكون 6 أحرف على الأقل');
                    this.updateFieldStyle('password', false);
                    this.updatePasswordStrength(0, 'ضعيفة جداً');
                    return false;
                }

                let score = 0;
                if (password.length >= 6) score++;
                if (password.length >= 8) score++;
                if (/[A-Z]/.test(password)) score++;
                if (/[0-9]/.test(password)) score++;
                if (/[^A-Za-z0-9]/.test(password)) score++;

                let strength, message;
                if (score <= 2) {
                    strength = 'weak';
                    message = 'ضعيفة';
                } else if (score <= 4) {
                    strength = 'medium';
                    message = 'متوسطة';
                } else {
                    strength = 'strong';
                    message = 'قوية';
                }

                const isValid = score >= 2;
                this.updateFieldValidation('password', isValid,
                    isValid ? `✓ قوة الكلمة: ${message}` : `✗ قوة الكلمة: ${message}`);
                this.updateFieldStyle('password', isValid);
                this.updatePasswordStrength(score, message);

                return isValid;
            }

            // ✅ التحقق من تطابق كلمة المرور
            validatePasswordMatch() {
                const password = document.getElementById('password').value;
                const confirmPassword = document.getElementById('confirm_password').value;

                if (confirmPassword.length === 0) {
                    this.updateFieldValidation('confirm_password', false, '✗ تأكيد كلمة المرور مطلوب');
                    this.updateFieldStyle('confirm_password', false);
                    return false;
                }

                if (password === confirmPassword) {
                    this.updateFieldValidation('confirm_password', true, '✓ كلمات المرور متطابقة');
                    this.updateFieldStyle('confirm_password', true);
                    return true;
                } else {
                    this.updateFieldValidation('confirm_password', false, '✗ كلمات المرور غير متطابقة');
                    this.updateFieldStyle('confirm_password', false);
                    return false;
                }
            }

            // ✅ التحقق من الدور
            validateRole(role) {
                const isValid = role !== '';
                this.updateFieldValidation('role', isValid,
                    isValid ? '✓ تم اختيار الدور' : '✗ يجب اختيار الدور');
                return isValid;
            }

            // ✅ تحديث قوة كلمة المرور
            updatePasswordStrength(score, message) {
                const bar = document.getElementById('passwordStrengthBar');
                const feedback = document.getElementById('passwordFeedback');

                bar.className = 'password-strength-bar';
                if (score <= 2) bar.classList.add('strength-weak');
                else if (score <= 4) bar.classList.add('strength-medium');
                else bar.classList.add('strength-strong');
            }

            // ✅ تحديث حالة الحقل
            updateFieldValidation(field, isValid, message) {
                const feedback = document.getElementById(field + 'Feedback');
                this.validationState[field] = isValid;

                if (feedback) {
                    feedback.textContent = message;
                    feedback.className = `feedback ${isValid ? 'valid' : 'invalid'}`;

                    const icon = feedback.querySelector('i') || document.createElement('i');
                    icon.className = `fas ${isValid ? 'fa-check-circle' : 'fa-exclamation-circle'}`;
                    if (!feedback.querySelector('i')) {
                        feedback.prepend(icon);
                    }
                }

                this.updateSubmitButton();
            }

            // ✅ تحديث نمط الحقل
            updateFieldStyle(field, isValid) {
                const input = document.getElementById(field);
                if (input) {
                    input.classList.remove('valid', 'invalid');
                    if (input.value.trim() !== '') {
                        input.classList.add(isValid ? 'valid' : 'invalid');
                    }
                }
            }

            // ✅ تحديث زر الإرسال
            updateSubmitButton() {
                const allValid = Object.values(this.validationState).every(Boolean);
                const btn = document.getElementById('registerBtn');

                btn.disabled = !allValid;
                btn.innerHTML = allValid ?
                    '<i class="fas fa-user-plus"></i> تأكيد إنشاء الحساب' :
                    '<i class="fas fa-lock"></i> يرجى إكمال جميع الحقول';
            }

            // ✅ إظهار/إخفاء كلمة المرور
            togglePasswordVisibility(fieldId, toggleId) {
                const input = document.getElementById(fieldId);
                const toggle = document.getElementById(toggleId);
                const icon = toggle.querySelector('i');

                if (input.type === 'password') {
                    input.type = 'text';
                    icon.className = 'fas fa-eye-slash';
                } else {
                    input.type = 'password';
                    icon.className = 'fas fa-eye';
                }
            }

            // ✅ معالجة إرسال النموذج
            async handleSubmit() {
                const formData = {
                    full_name: document.getElementById('full_name').value.trim(),
                    username: document.getElementById('username').value.trim(),
                    email: document.getElementById('email').value.trim(),
                    phone: document.getElementById('phone').value.trim(),
                    password: document.getElementById('password').value,
                    role: document.getElementById('role').value,
                    specialization: document.getElementById('specialization').value.trim()
                };

                // التحقق النهائي
                if (!this.isFormValid()) {
                    Utils.showMessage('❌ يرجى تصحيح جميع الأخطاء قبل المتابعة', 'error');
                    this.shakeForm();
                    return;
                }

                await this.registerUser(formData);
            }

            // ✅ التحقق النهائي من النموذج
            isFormValid() {
                return Object.values(this.validationState).every(Boolean);
            }

            // ✅ هز النموذج عند الخطأ
            shakeForm() {
                const form = document.getElementById('registerForm');
                form.classList.add('shake');
                setTimeout(() => form.classList.remove('shake'), 500);
            }

            // ✅ تسجيل المستخدم
            async registerUser(userData) {
                try {
                    Utils.showLoading('جاري إنشاء حسابك...');

                    const response = await fetch('/api/auth/register', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify(userData)
                    });

                    const data = await response.json();

                    if (data.success) {
                        Utils.showMessage('✅ تم إنشاء حسابك بنجاح! يتم توجيهك إلى صفحة تسجيل الدخول.', 'success');

                        setTimeout(() => {
                            Utils.redirect('/login', 'تم إنشاء حسابك بنجاح. يرجى تسجيل الدخول.', 'success');
                        }, 2000);
                    } else {
                        throw new Error(data.message || 'فشل في إنشاء الحساب');
                    }
                } catch (error) {
                    console.error('Register error:', error);
                    Utils.showMessage('❌ ' + error.message, 'error');
                } finally {
                    Utils.hideLoading();
                }
            }
        }

        // ✅ تهيئة مدير التسجيل عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', () => {
            new RegisterManager();
        });
    </script>
</body>

</html>